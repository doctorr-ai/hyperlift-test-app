import * as React from "react";

/** 1) Hook đọc & ghi ?mode vào URL (no reload) */
function useQueryParamMode(defaultMode = "auction") {
  const read = React.useCallback(() => {
    const p = new URLSearchParams(window.location.search);
    return (p.get("mode") || defaultMode).toLowerCase();
  }, [defaultMode]);

  const [mode, setMode] = React.useState<string>(read);

  // Ghi vào URL khi mode đổi (history.replaceState để không reload)
  React.useEffect(() => {
    const url = new URL(window.location.href);
    url.searchParams.set("mode", mode);
    window.history.replaceState(null, "", url);
  }, [mode]);

  // Lắng nghe back/forward
  React.useEffect(() => {
    const onPop = () => setMode(read());
    window.addEventListener("popstate", onPop);
    return () => window.removeEventListener("popstate", onPop);
  }, [read]);

  return { mode, setMode };
}

/** 2) ModeSwitcher – nút nhanh đổi chế độ */
function ModeSwitcher({
  mode,
  onChange,
  modes = ["auction", "onepage", "derm", "tcm"],
}: {
  mode: string;
  onChange: (m: string) => void;
  modes?: string[];
}) {
  return (
    <div style={{ display: "flex", gap: 8, flexWrap: "wrap" }}>
      {modes.map((m) => {
        const active = m === mode;
        return (
          <button
            key={m}
            onClick={() => onChange(m)}
            style={{
              padding: "8px 12px",
              borderRadius: 12,
              border: `1px solid ${active ? "#22c55e" : "rgba(0,0,0,.2)"}`,
              background: active ? "rgba(34,197,94,.12)" : "transparent",
              fontWeight: 700,
              cursor: "pointer",
            }}
            aria-pressed={active}
          >
            {m}
          </button>
        );
      })}
    </div>
  );
}

/** 3) View mapping – gắn các mode với component tương ứng */
const VIEWS: Record<string, React.FC> = {
  auction: AuctionUI,
  onepage: HealthcareOnePage, // one-page tổng hợp
  derm: DermDemo,             // ví dụ demo da liễu
  tcm: TcmDemo,               // ví dụ demo TCM
};

/** 4) App gốc – chọn view theo ?mode */
export default function App() {
  const { mode, setMode } = useQueryParamMode("auction");
  const View = VIEWS[mode] ?? AuctionUI;

  return (
    <Shell>
      <header style={{ display: "flex", justifyContent: "space-between", gap: 12, alignItems: "center", marginBottom: 14 }}>
        <div style={{ fontWeight: 800 }}>Amie Healthcare — One Click</div>
        <ModeSwitcher mode={mode} onChange={setMode} />
      </header>
      <View />
      <footer style={{ marginTop: 16, opacity: 0.7, fontSize: 12 }}>
        Current mode: <b>{mode}</b> — Try <code>?mode=onepage</code>, <code>?mode=derm</code>, <code>?mode=tcm</code>
      </footer>
    </Shell>
  );
}

/* ---------- Below are example view components ---------- */
/** Shell: khung thẻ có padding + responsive max-width */
function Shell({ children }: { children: React.ReactNode }) {
  return (
    <div
      style={{
        maxWidth: 960,
        margin: "0 auto",
        padding: 16,
        fontFamily:
          "Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif",
      }}
    >
      <div
        style={{
          border: "1px solid rgba(0,0,0,.12)",
          borderRadius: 16,
          padding: 16,
          boxShadow: "0 12px 28px rgba(16,24,40,.08)",
          background: "#fff",
        }}
      >
        {children}
      </div>
    </div>
  );
}

/** AuctionUI: NHÚNG UI HIỆN TẠI CỦA BẠN Ở ĐÂY
 *  - Cách dùng: dán JSX/logic cũ của bạn vào trong component này.
 */
function AuctionUI() {
  return (
    <div>
      <h2 style={{ marginTop: 0 }}>Auction UI</h2>
      <p style={{ marginTop: 8 }}>
        Place your existing auction interface here. This view shows when{" "}
        <code>?mode=auction</code> or no mode is set.
      </p>
      {/* TODO: paste your current components here (Countdown, Overlay, etc.) */}
    </div>
  );
}

/** HealthcareOnePage: one-page tổng hợp (bản gọn, mobile-first) */
function HealthcareOnePage() {
  return (
    <div>
      <h2 style={{ marginTop: 0 }}>One-Page: Healthcare AI — Herbal/TCM & Dermatology</h2>

      <Section title="Clinical & Pharmaceutical AI">
        <UL>
          <LI>DDx Assist: <b>AMIE</b>; Multi-modal: <b>Med-Gemini/MedLM</b>, <b>Med-PaLM 2</b></LI>
          <LI>Ops (non-diagnostic): <b>Hippocratic AI</b></LI>
          <LI>R&D: <b>AlphaFold 3</b> + <b>NVIDIA BioNeMo</b></LI>
        </UL>
      </Section>

      <Section title="Herbal / TCM AI">
        <UL>
          <LI>General LLMs: GPT-4o / Qwen 2.5 Max / Doubao 1.5 Pro</LI>
          <LI>Domain: TCM-GPT / HuatuoGPT / ShenNong-TCM</LI>
          <LI>Safety: RAG over pharmacopeias + Herb-Drug Interaction KG</LI>
        </UL>
      </Section>

      <Section title="Dermatology AI">
        <UL>
          <LI>Primary care triage: <b>DermaSensor</b> (FDA De Novo)</LI>
          <LI>System triage (UK/EU): <b>Skin Analytics — DERM</b> (NHS)</LI>
          <LI>Inflammatory: ISIC SOTA + local validation; assistive mode</LI>
          <LI>Consumer: Lens/DermAssist → education, not diagnosis</LI>
        </UL>
      </Section>

      <Section title="Implementation Roadmap">
        <UL>
          <LI>Data & Governance • Safety & Eval • Regulatory alignment</LI>
          <LI>Architecture: Intake → Preprocess/QC → Multi-model → RAG(KGs) → Risk/Advice → Audit</LI>
        </UL>
      </Section>
    </div>
  );
}

/** Derm demo (placeholder) */
function DermDemo() {
  return (
    <div>
      <h2 style={{ marginTop: 0 }}>Dermatology Demo</h2>
      <p>Plug your derm classifier/triage UI here (ISIC SOTA + local fine-tune).</p>
    </div>
  );
}

/** TCM demo (placeholder) */
function TcmDemo() {
  return (
    <div>
      <h2 style={{ marginTop: 0 }}>TCM / Herbal Demo</h2>
      <p>LLM + RAG on pharmacopeias + herb-drug interaction KG.</p>
    </div>
  );
}

/* ---------- Small UI helpers ---------- */
function Section({ title, children }: { title: string; children: React.ReactNode }) {
  return (
    <section
      style={{
        margin: "12px 0",
        padding: 12,
        borderRadius: 12,
        border: "1px solid rgba(0,0,0,.1)",
        background: "linear-gradient(180deg,#fff,#fafafa)",
      }}
    >
      <h3 style={{ marginTop: 0, marginBottom: 8 }}>{title}</h3>
      {children}
    </section>
  );
}

function UL({ children }: { children: React.ReactNode }) {
  return <ul style={{ margin: 0, paddingLeft: 18 }}>{children}</ul>;
}

function LI({ children }: { children: React.ReactNode }) {
  return <li style={{ margin: "6px 0" }}>{children}</li>;
}
